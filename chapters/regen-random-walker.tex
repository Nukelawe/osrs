\subsection{Regenerating random walker}\label{chap:regen-walker}
When regeneration is considered, the random walk that was used to describe a fight in Chapter~\ref{chap:fightDef} gets new edges. Now it will be possible to walk backwards as well as forwards in the state space. Unfortunately, since regeneration attempts happen with a fixed period $T_R$, the transition probabilities will vary with time. Furthermore, when the regeneration attempts do occur they might not coincide with the damaging events.

To incorporate the two events in the same random walker formalism, consider the time interval $\Delta t_k = [t_k, t_{k+1}-1]$, where $t_k$ is the (game)tick on which the $k$th hit occurs. A single transition of the random walker is now determined by the overall state change that takes place during time interval $\Delta t_k$. Since we have assumed $T_R \geq T_A$ the number of regeneration attempts during $\Delta t_k$ is at most 1.
The assumption $T_A \leq T_B$ should hold for nearly all cases in practice as the the typical regeneration period is 60 seconds and even the slowest weapons have attack periods of just 4.2 seconds. For some rarer cases such as flinching an enemy with unusually high regeneration rate where this could become a problem one could simply allow the regeneration of more than 1 hitpoint per attack interval.

The only source of randomness in the regeneration model is the tick $\tau$ on which the first regeneration attempt occurs. We treat it as a random variable distributed uniformly in the interval $[1, T_R]$. Alternatively $\tau$ can be thought of as the time until the next regeneration attempt at the beginning of a fight. Now the expected length of a fight is
\begin{align}
	\langle L_j \rangle
		&= \sum_{n=1}^{\infty}n\Pr{L_j=\,n}\nonumber\\
		&= \sum_{n=1}^{\infty}n\sum_{\tau=1}^{T_R}\Pr{\tau}\Pr{L_j=\,n \mid \tau}\nonumber\\
		&= \frac{1}{T_R}\sum_{\tau=1}^{T_R}\sum_{n=1}^{\infty}n\Pr{L_j=\,n \mid \tau}\nonumber\\
		&= \frac{1}{T_R}\sum_{\tau=1}^{T_R} \langle L_j^\tau \rangle
\end{align}
where $L_j^\tau$ is the length of a fight at the beginning of which the next regeneration attempt is $\tau$ ticks away. While not shown here, by almost identical reasoning to that in Chapter~\ref{chap:fightDef} one can derive the recurrence relation
\begin{align}\label{eq:regenrecurrence}
	\langle L_j^\tau \rangle
		&= 1 + \sum_{i=1}^{h} p_{ij}^\tau \langle L_i^{\tau - T_A} \rangle.
\end{align}
The only critical difference besides the transition probabilities is the recursion argument. Now in addition to modifying the remaining hitpoints, hitting the enemy also shifts $\tau$ backwards by $T_A$ ticks since this is the amount of time that passes between hits. The time-dependent transition probabilities are given by
\begin{align}
    p_{ij}^\tau
        &= \begin{cases}
			p_{ij} \quad &\mbox{if } \tau > T_A \pmod {T_R} \\
			p_{i,\min(j+1,h)} \quad &\mbox{if } \tau \leq T_A \pmod {T_R}
		\end{cases}\label{eq:damageDistribution}.
\end{align}
where $p_{ij}$ is the transition probability of the non-regenerating case (eq\ref{eq:noregenProb}). The minimum is taken to prevent hitpoints from exceeding $h$ and modular arithmetic used to handle the periodicity of the regeneration cycle.

Because of the backwards transition that regeneration has made possible, all states are now dependent on one another. Therefore, a recursive solution similar to that in Chapter~\ref{chap:noregen} is no longer possible and eq\ref{eq:regenrecurrence} should instead be treated as a linear system of $h$ equations. Furthermore, the time shift in the $\tau$-dependency splits them further making the system actually $hT_R/\gcd(T_R, T_A)$-dimensional.
For example in case of fighting ankous with a scimitar ($h=60$, $T_R=100$, $T_A=4$) we would have to solve a system of 1500 equations.
\pagebreak
